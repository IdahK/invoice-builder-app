services:
  postgres:
    extends:
      file: docker-compose.yml
      service: postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    # Remove ports exposure in production (use internal network)
    ports: []

  backend:
    extends:
      file: docker-compose.yml
      service: backend
    environment:
      SPRING_PROFILES_ACTIVE: prod
      LOGGING_LEVEL_ROOT: WARN
      LOGGING_LEVEL_OR_INVOICEBUILDER: INFO
    # Remove source code mount in production
    volumes:
      - uploads_data:/app/uploads
    # Use built JAR, not development
    command: ["java", "-jar", "target/invoicebuilder-0.0.1-SNAPSHOT.jar"]
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  frontend:
    extends:
      file: docker-compose.yml
      service: frontend
    environment:
      REACT_APP_API_URL: /api/v1
      REACT_APP_ENV: production
    # Remove source code mount in production
    volumes: []
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 128M

  nginx:
    extends:
      file: docker-compose.yml
      service: nginx
    volumes:
      - ./nginx/nginx.prod.conf:/etc/nginx/conf.d/default.conf
      - ./nginx/ssl:/etc/nginx/ssl
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
